<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Happy Birthday — Special</title>
  <style>
    :root{
      --pink:#ff7ac8;
      --soft-pink:#ffd1e8;
      --hot-pink:#ff4db3;
      --purple:#b36cff;
      --gold:gold;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:#000;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";overflow:hidden}

    /* ===== Z-LAYERED CANVASES ===== */
    canvas{position:fixed;top:0;left:0;width:100vw;height:100vh;display:block}
    #cvMatrix{z-index:0}
    #cvStars{z-index:1}
    #cvParticles{z-index:2}
    #cvFireworks{z-index:3}

    /* ===== INTRO FORM ===== */
    #intro{position:fixed;inset:0;z-index:10;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.9);}
    .intro-card{width:min(92vw,460px);padding:20px;border-radius:16px;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));backdrop-filter:blur(6px);box-shadow:0 10px 40px rgba(255,122,200,.2);text-align:center}
    .intro-title{font-size:clamp(20px,5vw,28px);margin:6px 0 14px;color:#fff;text-shadow:0 0 10px var(--soft-pink)}
    .intro-img{width:120px;height:120px;border-radius:16px;background:radial-gradient(circle at 30% 30%, var(--soft-pink), transparent 60%);margin:0 auto 12px}
    .row{display:flex;gap:10px;justify-content:center;align-items:center;margin-top:6px}
    #dob{flex:1;min-width:0;padding:12px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:#fff;font-size:16px;outline:none}
    #dob::placeholder{color:#ddd}
    #go{padding:12px 18px;border:none;border-radius:12px;background:linear-gradient(90deg,var(--hot-pink),var(--purple));color:#fff;font-weight:700;cursor:pointer;box-shadow:0 6px 20px rgba(255,77,179,.35)}
    .hint{font-size:12px;opacity:.8;margin-top:8px}

    /* ===== TOP TITLE ===== */
    #topTitle{position:fixed;top:4.5vh;left:50%;transform:translateX(-50%);z-index:5;font-size:clamp(28px,6vw,54px);font-weight:900;letter-spacing:.02em;color:#fff;text-align:center;text-shadow:0 0 20px #fff, 0 0 36px var(--soft-pink), 0 0 64px var(--hot-pink);display:none}
    .shine{animation:shine 2.2s ease-in-out infinite alternate}
    @keyframes shine{from{filter:drop-shadow(0 0 8px #fff)}to{filter:drop-shadow(0 0 20px var(--soft-pink)) drop-shadow(0 0 40px var(--hot-pink))}}

    /* ===== CENTER HUD (for accessibility text fallback) ===== */
    #centerHUD{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:4;pointer-events:none}
    #centerText{font-size:clamp(48px,18vw,200px);font-weight:900;color:#fff;opacity:0;text-shadow:0 0 20px #fff, 0 0 40px var(--soft-pink), 0 0 80px var(--hot-pink)}

    /* ===== 3D RING SLIDER ===== */
    #ringWrap{position:fixed;left:50%;bottom:9vh;transform:translateX(-50%);width:min(90vw,560px);height:min(90vw,560px);z-index:6;display:none}
    #ring{position:absolute;inset:0;margin:auto;transform-style:preserve-3d}
    .card{position:absolute;width:min(34vw,180px);height:min(34vw,180px);left:50%;top:50%;transform-style:preserve-3d;border-radius:18px;overflow:hidden;box-shadow:0 8px 22px rgba(255,255,255,.18)}
    .card img{width:100%;height:100%;object-fit:cover;display:block}
    .card::after{content:"";position:absolute;inset:0;box-shadow:inset 0 0 0 2px rgba(255,255,255,.15);border-radius:18px;pointer-events:none}
    .card.active{transform:scale(1.12) translateZ(var(--z)) rotateY(var(--ry));z-index:10;box-shadow:0 10px 30px rgba(255,255,255,.5)}

    /* hint/message bubble */
    #bubble{position:fixed;left:50%;bottom:3vh;transform:translateX(-50%);max-width:92vw;background:rgba(0,0,0,.6);padding:10px 14px;border-radius:14px;border:1px solid rgba(255,255,255,.18);box-shadow:0 6px 24px rgba(255,122,200,.25);font-size:clamp(13px,3.6vw,18px);display:none;z-index:7}

    /* ===== MUSIC BUTTON ===== */
    #musicBtn{position:fixed;top:10px;right:10px;z-index:11;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.2);color:#fff;border-radius:999px;padding:8px 12px;backdrop-filter:blur(4px);cursor:pointer}
    #musicBtn.active{background:linear-gradient(90deg,var(--hot-pink),var(--purple))}

    /* RESPONSIVE TWEAKS */
    @media (max-width:480px){
      .intro-card{padding:16px}
      .intro-img{width:96px;height:96px}
    }
  </style>
</head>
<body>
  <!-- BACKGROUND LAYERS -->
  <canvas id="cvMatrix"></canvas>
  <canvas id="cvStars"></canvas>
  <canvas id="cvParticles"></canvas>
  <canvas id="cvFireworks"></canvas>

  <!-- INTRO OVERLAY -->
  <div id="intro">
    <div class="intro-card">
      <div class="intro-img"></div>
      <div class="intro-title">Nhập ngày sinh (dd/mm)</div>
      <div class="row">
        <input id="dob" placeholder="ví dụ: 17/08" inputmode="numeric" autocomplete="off" />
        <button id="go">Vào</button>
      </div>
      <div class="hint">Mẹo: Chạm nút Vào để bật nhạc trên điện thoại 🎵</div>
    </div>
  </div>

  <!-- MUSIC CONTROL -->
  <button id="musicBtn">🎵 Nhạc</button>
  <audio id="bgm" preload="auto" loop>
    <!-- Bạn có thể thay bằng file mp3 của bạn -->
    <source src="audio/HPBD.mp3" type="audio/mpeg" />
  </audio>

  <!-- CENTER HUD (for accessibility text fallback; particles render on canvas) -->
  <div id="centerHUD"><div id="centerText"></div></div>

  <!-- TOP TITLE shown after words -->
  <div id="topTitle" class="shine">🎉 HAPPY BIRTHDAY 🎉</div>

  <!-- 3D RING SLIDER -->
  <div id="ringWrap">
    <div id="ring"></div>
  </div>
  <div id="bubble"></div>

  <script>
  /******************* UTILS *******************/
  const DPR = Math.max(1, Math.min(window.devicePixelRatio || 1, 2));
  const clamp = (v, mi, ma) => Math.max(mi, Math.min(ma, v));
  const rand = (a,b)=> a + Math.random()*(b-a);

  /******************* MATRIX (pink + white HAPPYBIRTHDAY rain) *******************/
  const mCanvas = document.getElementById('cvMatrix');
  const mCtx = mCanvas.getContext('2d');
  function resizeMatrix(){ mCanvas.width = innerWidth*DPR; mCanvas.height = innerHeight*DPR; }
  resizeMatrix();
  let mFont = 16*DPR; let mCols = Math.floor(mCanvas.width / mFont);
  let drops = new Array(mCols).fill(1);
  const chars = 'HAPPYBIRTHDAY'.split('');
  function drawMatrix(){
    mCtx.fillStyle = 'rgba(0,0,0,0.06)';
    mCtx.fillRect(0,0,mCanvas.width,mCanvas.height);
    mCtx.font = `bold ${mFont}px Arial`;
    for(let i=0;i<drops.length;i++){
      mCtx.fillStyle = Math.random()>0.5? '#fff' : '#ffd1e8';
      const ch = chars[(Math.random()*chars.length)|0];
      mCtx.fillText(ch, i*mFont, drops[i]*mFont);
      if(drops[i]*mFont > mCanvas.height && Math.random()>0.975) drops[i]=0;
      drops[i]++;
    }
    requestAnimationFrame(drawMatrix);
  }
  requestAnimationFrame(drawMatrix);

  /******************* SHOOTING STARS (dreamy pink/purple) *******************/
  const sCanvas = document.getElementById('cvStars');
  const sCtx = sCanvas.getContext('2d');
  function resizeStars(){ sCanvas.width = innerWidth*DPR; sCanvas.height = innerHeight*DPR; }
  resizeStars();
  class ShootingStar{
    constructor(){ this.reset(true); }
    reset(init=false){
      this.x = rand(0, sCanvas.width);
      this.y = rand(0, sCanvas.height*0.5);
      this.len = rand(120*DPR, 240*DPR);
      this.speed = rand(0.4, 1.0); // slow
      this.size = rand(1.2*DPR, 2.2*DPR);
      if(!init){ this.x = sCanvas.width + this.len; this.y = rand(0, sCanvas.height*0.5); }
    }
    step(){
      this.x -= this.speed*6*DPR; // move left
      this.y += this.speed*2.8*DPR; // move down a bit
      if(this.x < -this.len || this.y > sCanvas.height + this.len) this.reset();
    }
    draw(){
      const gx = this.x, gy = this.y, tx = this.x - this.len, ty = this.y + this.len;
      const grad = sCtx.createLinearGradient(gx,gy,tx,ty);
      grad.addColorStop(0, 'rgba(255,160,220,1)');
      grad.addColorStop(1, 'rgba(180,120,255,0)');
      sCtx.lineWidth = this.size; sCtx.strokeStyle = grad;
      sCtx.beginPath(); sCtx.moveTo(gx,gy); sCtx.lineTo(tx,ty); sCtx.stroke();
      // bright head
      sCtx.fillStyle = 'rgba(255,200,255,.9)';
      sCtx.beginPath(); sCtx.arc(gx,gy,this.size*0.9,0,Math.PI*2); sCtx.fill();
    }
  }
  const stars = Array.from({length:8}, ()=> new ShootingStar());
  function loopStars(){
    sCtx.clearRect(0,0,sCanvas.width,sCanvas.height);
    for(const st of stars){ st.step(); st.draw(); }
    requestAnimationFrame(loopStars);
  }
  requestAnimationFrame(loopStars);

  /******************* PARTICLE TEXT (countdown + words) *******************/
  const pCanvas = document.getElementById('cvParticles');
  const pCtx = pCanvas.getContext('2d');
  function resizeParticles(){ pCanvas.width = innerWidth*DPR; pCanvas.height = innerHeight*DPR; }
  resizeParticles();
  const centerText = document.getElementById('centerText');

  let particles = [];
  const pointGap = Math.round(clamp(6*DPR, 4, 10));

  function getPointsForText(txt, sizePx){
    const off = document.createElement('canvas');
    off.width = pCanvas.width; off.height = pCanvas.height;
    const o = off.getContext('2d');
    o.clearRect(0,0,off.width,off.height);
    o.fillStyle = '#fff';
    o.font = `900 ${sizePx}px Arial`;
    o.textAlign = 'center'; o.textBaseline = 'middle';
    o.fillText(txt, off.width/2, off.height/2);
    const data = o.getImageData(0,0,off.width,off.height).data;
    const pts = [];
    for(let y=0;y<off.height;y+=pointGap){
      for(let x=0;x<off.width;x+=pointGap){
        const idx = (y*off.width + x)*4 + 3; // alpha channel
        if(data[idx] > 150){ pts.push({x,y}); }
      }
    }
    return pts;
  }

  function makeParticles(targetPts){
    const arr = [];
    for(const t of targetPts){
      arr.push({
        x: rand(0,pCanvas.width), y: rand(0,pCanvas.height),
        vx: 0, vy: 0, tx: t.x, ty: t.y, a: 1,
      });
    }
    return arr;
  }

  function animateToText(txt, size, assembleMs, holdMs){
    return new Promise(resolve=>{
      const pts = getPointsForText(txt, size);
      particles = makeParticles(pts);
      let t0 = performance.now();
      const attract = 0.12; // pull strength
      const damp = 0.86;    // friction

      function frame(now){
        const elapsed = now - t0;
        pCtx.clearRect(0,0,pCanvas.width,pCanvas.height);
        // draw faint glow background to pop on black
        for(const p of particles){
          const dx = p.tx - p.x, dy = p.ty - p.y;
          p.vx += dx*attract*0.016; // normalized by ~60fps
          p.vy += dy*attract*0.016;
          p.vx *= damp; p.vy *= damp;
          p.x += p.vx;  p.y += p.vy;
          // particle
          pCtx.fillStyle = 'rgba(255,182,219,0.95)';
          pCtx.fillRect(p.x, p.y, Math.max(1,DPR), Math.max(1,DPR));
        }
        if(elapsed < assembleMs + holdMs){
          requestAnimationFrame(frame);
        }else{
          resolve();
        }
      }
      requestAnimationFrame(frame);
    });
  }

  function explodeParticles(ms=700){
    return new Promise(resolve=>{
      // give random velocities
      for(const p of particles){
        const ang = Math.random()*Math.PI*2; const sp = rand(1, 5)*DPR;
        p.vx = Math.cos(ang)*sp; p.vy = Math.sin(ang)*sp; p.a = 1;
      }
      const gravity = 0.05*DPR; const fade = 0.02;
      let t0 = performance.now();
      function frame(now){
        pCtx.clearRect(0,0,pCanvas.width,pCanvas.height);
        for(const p of particles){
          p.vy += gravity;
          p.x += p.vx; p.y += p.vy; p.a -= fade;
          if(p.a<0) p.a = 0;
          pCtx.fillStyle = `rgba(255,150,220,${p.a})`;
          pCtx.fillRect(p.x,p.y, Math.max(1,DPR), Math.max(1,DPR));
        }
        if(now - t0 < ms){ requestAnimationFrame(frame); }
        else { pCtx.clearRect(0,0,pCanvas.width,pCanvas.height); resolve(); }
      }
      requestAnimationFrame(frame);
    });
  }

  async function runSequence(){
    const numbers = ['3','2','1'];
    for(const n of numbers){
      centerText.style.opacity = 1; centerText.textContent = n;
      await animateToText(n, Math.round(Math.min(pCanvas.width,pCanvas.height)*0.28), 700, 300);
      await explodeParticles(600);
    }
    centerText.style.opacity = 0;
    const words = ['Chúc','Mừng','Sinh','Nhật','Haa','Anh'];
    for(const w of words){
      await animateToText(w, Math.round(Math.min(pCanvas.width,pCanvas.height)*0.16), 800, 700); // ~1.5s total
      await explodeParticles(700);
    }
    // After done → show title + fireworks + ring
    document.getElementById('topTitle').style.display = 'block';
    startFireworks();
    showRing();
  }

  /******************* FIREWORKS *******************/
  const fCanvas = document.getElementById('cvFireworks');
  const fCtx = fCanvas.getContext('2d');
  function resizeFireworks(){ fCanvas.width = innerWidth*DPR; fCanvas.height = innerHeight*DPR; }
  resizeFireworks();
  let fwParticles = [];
  function spawnBurst(x,y,colors){
    const count = 80;
    for(let i=0;i<count;i++){
      const ang = Math.random()*Math.PI*2; const sp = rand(1.5,5)*DPR;
      fwParticles.push({x,y,vx:Math.cos(ang)*sp, vy:Math.sin(ang)*sp, a:1, r:rand(1,2.4)*DPR, c:colors[(Math.random()*colors.length)|0]});
    }
  }
  let fwRunning=false; let lastFW=0;
  function fwLoop(ts){
    fCtx.fillStyle = 'rgba(0,0,0,0.2)'; fCtx.fillRect(0,0,fCanvas.width,fCanvas.height);
    for(let i=fwParticles.length-1;i>=0;i--){
      const p = fwParticles[i];
      p.vy += 0.02*DPR; p.vx *= 0.992; p.vy *= 0.992; p.a -= 0.009;
      p.x += p.vx; p.y += p.vy;
      if(p.a<=0){ fwParticles.splice(i,1); continue; }
      fCtx.globalCompositeOperation='lighter';
      fCtx.fillStyle = p.c.replace('ALPHA', p.a.toFixed(3));
      fCtx.beginPath(); fCtx.arc(p.x,p.y,p.r,0,Math.PI*2); fCtx.fill();
      fCtx.globalCompositeOperation='source-over';
    }
    if(fwRunning){
      if(ts - lastFW > 400){ // spawn periodically
        lastFW = ts;
        spawnBurst(rand(fCanvas.width*0.15,fCanvas.width*0.85), rand(fCanvas.height*0.15,fCanvas.height*0.6), [
          'rgba(255,200,255,ALPHA)', 'rgba(255,150,220,ALPHA)', 'rgba(180,120,255,ALPHA)', 'rgba(255,255,255,ALPHA)'
        ]);
      }
      requestAnimationFrame(fwLoop);
    }
  }
  function startFireworks(){ if(!fwRunning){ fwRunning=true; requestAnimationFrame(fwLoop);} }

  /******************* RING SLIDER (7 images) *******************/
  const ringWrap = document.getElementById('ringWrap');
  const ring = document.getElementById('ring');
  const bubble = document.getElementById('bubble');
  let angle = 0; let autoSpin = true; let lastT = 0; let radius = 260; // will update after layout

  const slides = [
    {src:'images/1.gif', msg:'Chúc mừng sinh nhật! 🎂'},
    {src:'images/2.jpg', msg:'Luôn vui vẻ, hạnh phúc ❤️'},
    {src:'images/3.jpg', msg:'Thành công và may mắn 🍀'},
    {src:'images/4.jpg', msg:'Sức khỏe dồi dào 💪'},
    {src:'images/5.jpg', msg:'Ước mơ sớm thành hiện thực ✨'},
    {src:'images/6.jpg', msg:'Yêu thương ngập tràn 💖'},
    {src:'images/7.jpg', msg:'Một năm tuyệt vời phía trước 🚀'}
  ];

  function buildRing(){
    ring.innerHTML = '';
    const rect = ringWrap.getBoundingClientRect();
    const size = Math.min(rect.width, rect.height);
    radius = size * 0.45; // translateZ
    const imgSize = Math.min(size*0.34, 200);

    const step = 360 / slides.length;
    slides.forEach((it, idx)=>{
      const card = document.createElement('div');
      card.className = 'card';
      const img = document.createElement('img'); img.src = it.src; img.alt = `img-${idx+1}`; card.appendChild(img);
      // positioning via CSS transform
      const a = step*idx;
      card.style.transform = `translate(-50%,-50%) rotateY(${a}deg) translateZ(${radius}px)`;
      card.style.setProperty('--z', radius+'px');
      card.style.setProperty('--ry', a+'deg');
      card.style.width = card.style.height = imgSize+'px';

      const showMsg = ()=>{ bubble.textContent = it.msg; bubble.style.display='block'; card.classList.add('active'); };
      const hideMsg = ()=>{ bubble.style.display='none'; card.classList.remove('active'); };
      card.addEventListener('mouseenter', showMsg);
      card.addEventListener('mouseleave', hideMsg);
      card.addEventListener('click', ()=>{ if(bubble.style.display==='block') hideMsg(); else showMsg(); });
      card.addEventListener('touchstart', (e)=>{ e.stopPropagation(); showMsg(); }, {passive:true});

      ring.appendChild(card);
    });
  }

  function spinLoop(ts){
    if(autoSpin){
      const dt = lastT? (ts-lastT)/1000 : 0; // seconds
      angle += dt * 8; // degrees per second (slow)
      ring.style.transform = `rotateY(${angle}deg)`;
      lastT = ts;
    }
    requestAnimationFrame(spinLoop);
  }

  function enableDrag(){
    let dragging=false, startX=0, startAngle=0;
    const onDown = (x)=>{ dragging=true; autoSpin=false; startX=x; startAngle=angle; bubble.style.display='none'; };
    const onMove = (x)=>{ if(!dragging) return; const dx = x-startX; angle = startAngle + dx*0.3; ring.style.transform = `rotateY(${angle}deg)`; };
    const onUp = ()=>{ dragging=false; autoSpin=true; };
    ringWrap.addEventListener('mousedown', e=>onDown(e.clientX));
    window.addEventListener('mousemove', e=>onMove(e.clientX));
    window.addEventListener('mouseup', onUp);
    ringWrap.addEventListener('touchstart', e=>onDown(e.touches[0].clientX), {passive:true});
    window.addEventListener('touchmove', e=>onMove(e.touches[0].clientX), {passive:true});
    window.addEventListener('touchend', onUp);
  }

  function showRing(){ ringWrap.style.display='block'; buildRing(); requestAnimationFrame(spinLoop); enableDrag(); }

  /******************* INTRO + MUSIC *******************/
  const BIRTHDAY = '17/08'; // <-- chỉnh ngày sinh ở đây (định dạng dd/mm)
  const intro = document.getElementById('intro');
  const goBtn = document.getElementById('go');
  const dob = document.getElementById('dob');
  const musicBtn = document.getElementById('musicBtn');
  const bgm = document.getElementById('bgm');
  let musicOn = false;

  function playMusic(){ bgm.play().then(()=>{ musicOn=true; musicBtn.classList.add('active'); }).catch(()=>{}); }
  musicBtn.addEventListener('click', ()=>{ if(musicOn){ bgm.pause(); musicOn=false; musicBtn.classList.remove('active'); } else { playMusic(); } });

  goBtn.addEventListener('click', ()=>{
    const v = (dob.value||'').trim();
    if(v === BIRTHDAY){
      intro.style.display='none';
      playMusic();
      runSequence();
    } else {
      alert('Sai ngày sinh rồi, thử lại nhé!');
    }
  });

  /******************* RESIZE HANDLERS *******************/
  function handleResize(){
    resizeMatrix(); mFont = 16*DPR; mCols = Math.floor(mCanvas.width/mFont); drops = new Array(mCols).fill(1);
    resizeStars(); resizeParticles(); resizeFireworks();
    if(ringWrap.style.display==='block') buildRing();
  }
  window.addEventListener('resize', handleResize);
  window.addEventListener('orientationchange', handleResize);
  </script>
</body>
</html>
